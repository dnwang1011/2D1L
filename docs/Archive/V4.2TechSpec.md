Okay, this is an exciting challenge! We're merging a deeply immersive and emotionally resonant UI/UX design with a robust backend technical specification. The goal is to create a single, coherent vision for the 2dots1line product.

I'll integrate your UI/UX notes directly into the V4TechSpec structure, creating new sections or modifying existing ones where appropriate. The key is to show how the backend *enables* the UI/UX, and how user interactions in the UI *trigger* backend processes and data flows.

Let's rebuild the technical specification with this UI/UX integration.

---

**2dots1line Memory System V5: Integrated Full Stack Product Specification**

**Document Version:** 5.0
**Date:** May 09, 2025
**Authors:** AI Collaboration (Claude, Gemini, GPT) with Human Direction & UI/UX Vision

## Executive Summary

The 2dots1line Memory System is a production-grade knowledge graph platform designed to transform a continuous stream of user inputs into a rich, interconnected personal knowledge model. It combines accurate memory retrieval with proactive pattern discovery, presented through an immersive, emotionally resonant user experience. This V5 specification harmonizes the V4 backend architecture with a unique layered UI (3D Canvas, 2D Modals, 3D Orb) to create a deeply personal and insightful journey for the user.

**Core Capabilities:**
- Efficient multi-modal data ingestion and knowledge graph construction.
- Hybrid retrieval combining vector, graph, and relational queries.
- Proactive insight generation through pattern discovery and metaphorical reasoning.
- Adaptive processing tiers for cost-efficient operation.
- Cross-region deployment (AWS/US and Tencent/China).
- **Integrated User Experience:** Coherent and beautiful interaction across web and mobile, featuring:
    - **Immersive 3D Canvas:** Symbolic scenes (Flight, Ascension, Cosmos) setting emotional tone and visualizing the knowledge graph.
    - **Glassmorphic 2D Modal Layer:** Structured UI for content (cards, dashboard, chat) floating over the 3D canvas.
    - **Responsive 3D Orb (Dot):** The AI's presence, guiding and interacting with the user across all layers.

## 1. System Architecture Overview

### 1.1 Foundational Principles

1.  **Tiered Processing Model:** Multi-level analysis pipeline (lightweight → deep) based on content significance.
2.  **Agent-Tool Paradigm:** Core cognitive agents with well-defined responsibilities + deterministic tool layer.
3.  **Polyglot Persistence:** Strategic use of specialized databases (relational, graph, vector, cache).
4.  **Clear Data Flow Contracts:** Typed payloads and explicit schema contracts between components.
5.  **Regional Adaptability:** Architecture designed for deployment in both US (AWS/Google AI) and China (Tencent/DeepSeek).
6.  **Progressive Enhancement:** System delivers value from day one, with knowledge graph enrichment improving over time.
7.  **UI-Backend Coherence:** Backend state and data directly drive UI elements (Orb behavior, scene transitions, card content, graph visualization). User interactions in the UI directly trigger backend agent workflows.

### 1.2 High-Level Architecture

(Diagram remains the same as V4, but it's understood that the "USER INTERFACE LAYER" now explicitly refers to the 3D Canvas, 2D Modal Layer, and 3D Orb.)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 USER INTERFACE LAYER (3D Canvas, 2D Modals, 3D Orb)     │
└───────────────────────────────────┬─────────────────────────────────────┘
                                   │
                  ┌───────────────▼───────────────┐
                  │      DIALOGUE AGENT (DOT)     │ (Manifests as 3D Orb)
                  └───────────────┬───────────────┘
                                 │
┌────────────────────────────────┼────────────────────────────────────────┐
│                  COGNITIVE AGENT LAYER                                  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌────────────┐│
│  │   INGESTION   │  │   RETRIEVAL   │  │    INSIGHT    │  │  ONTOLOGY  ││
│  │    ANALYST    │  │    PLANNER    │  │    ENGINE     │  │  STEWARD   ││
│  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  └─────┬──────┘│
└──────────┼─────────────────┼─────────────────┼───────────────────┼──────┘
           │                 │                 │                   │
┌──────────┼─────────────────┼─────────────────┼───────────────────┼──────┐
│                  DETERMINISTIC TOOLS LAYER                              │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ NER/Vision/Embedding/LLM/Reranking/Stats/Extraction/Summarize   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└──────────┼─────────────────┼─────────────────┼───────────────────┼──────┘
           │                 │                 │                   │
┌──────────▼─────────────────▼─────────────────▼───────────────────▼──────┐
│                      PERSISTENCE LAYER                                  │
│  ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐      │
│  │ PostgreSQL │   │   Neo4j    │   │  Weaviate  │   │   Redis    │      │
│  └────────────┘   └────────────┘   └────────────┘   └────────────┘      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 Core Components

(As in V4, with Dialogue Agent explicitly linked to Orb)

1.  **Cognitive Agents:**
    *   **Dialogue Agent (Dot):** The only agent directly communicating with users, visually represented as the **3D Orb**. Its state and responses dictate Orb behavior, appearance, and interactions with UI elements.
    *   Ingestion Analyst, Retrieval Planner, Insight Engine, Ontology Steward (as in V4).
2.  **Deterministic Tools Layer:** As in V4.
3.  **Persistence Layer:** As in V4.
4.  **Data Flow Orchestration:** As in V4.

## 1.A User Experience & Interface Integration (NEW SECTION)

The 2dots1line experience is delivered through a unique, three-layered interface architecture, designed to be immersive, intuitive, and emotionally resonant. These layers are powered by and interact with the backend system.

### 1.A.1 The Three UI Layers

1.  **3D Canvas Layer (Environment & Symbolism):**
    *   **Purpose:** Sets the emotional tone, provides an immersive backdrop, and visualizes the knowledge graph.
    *   **Scenes:**
        *   **Flight Scene:** Looping cinematic flight over cloudscapes and snowy peaks (sunset/sunrise hues). Evokes serenity, hope, momentum. Orb behavior: calm, guiding.
        *   **Ascension Scene:** Dynamic flythrough from atmosphere to starlight, transitioning to the knowledge graph. Evokes transcendence, clarity. Orb behavior: leading, transformative.
        *   **Cosmos Graph Scene:** Interactive 3D visualization of the user's personal knowledge graph. Nodes (memories, concepts) as celestial bodies, connections as light trails. Evokes discovery, interconnectedness. Orb behavior: companion, coach.
    *   **Backend Interaction:**
        *   Scene state (Flight, Ascension, Cosmos) is managed by the frontend, but can be influenced by `Dialogue Agent` suggestions (e.g., "Shall we explore your cosmos?").
        *   The `Cosmos Graph Scene` directly visualizes data from `Neo4j` (Concepts, Communities, Relationships) and `PostgreSQL` (MemoryUnit summaries for node details). `Retrieval Planner` fetches this data.

2.  **2D Modal Layer (Structure & Content):**
    *   **Purpose:** Hosts structured UI elements for interaction, content display, and task completion, floating with a glassmorphism effect over the 3D canvas.
    *   **Key Components:**
        *   **Infinite Card Gallery:** A scrollable 2D field of "Cards." Each card represents a `MemoryUnit`, `Concept`, or a `DerivedArtifact` (e.g., an AI-generated summary/story from multiple nodes). Cards have visual states reflecting user engagement and the "Six-Dimensional Growth Model."
        *   **Card-Specific Modal:** Opens when a card is clicked, showing detailed information (text, media, stats, linked items) and prompts for interaction (journaling, reflection).
        *   **Dashboard:** Landing modal for stats, updates, `Insight Engine` outputs, and action items.
        *   **Chat Modals:** Dedicated dialogue boxes for interaction with the `Dialogue Agent (Orb)`, can be anchored or follow the Orb.
        *   **HUD (Heads-Up Display):** Minimalist control hub for scene switching, navigation shortcuts, journal triggering, and accessing the Dashboard.
    *   **Backend Interaction:**
        *   Card content is populated from `PostgreSQL` (MemoryUnits, Concepts, Annotations, DerivedArtifacts) and `Neo4j` (relationships).
        *   User interactions (e.g., journaling into a card) trigger the `Ingestion Analyst`.
        *   The "Six-Dimensional Growth Model" state for cards is stored in `PostgreSQL` and updated by agents based on user activity.
        *   Dashboard content is dynamically fetched by the `Dialogue Agent` using the `Retrieval Planner` and `Insight Engine`.

3.  **3D Orb (Presence & Guidance):**
    *   **Purpose:** The visual manifestation of the `Dialogue Agent (Dot)`. A real-time animated 3D presence floating in front of all other UI elements. It's personal, responsive, and narrative.
    *   **Behavior:**
        *   Proactively interacts with the user.
        *   Can trigger scene changes or activate/interact with 2D modals.
        *   Visual appearance (color, glow, pulse, animation, particle effects) changes based on its current state (idle, listening, thinking, insightful), the active 3D scene, and user interaction.
        *   Handles chat dialogue.
    *   **Backend Interaction:**
        *   The Orb's appearance and behavior are directly driven by state information and cues included in the `Dialogue Agent`'s output payload.
        *   User speech/text input to the Orb is processed by the `Dialogue Agent`.
        *   Orb suggestions (e.g., "Let's explore this concept card") trigger actions in the 2D Modal Layer, often involving the `Retrieval Planner` or `Ingestion Analyst`.

### 1.A.2 Design Principles (from UI/UX Notes)

*   **Immersion:** Fullscreen canvas, slow camera easing, ambient light, atmospheric fog.
*   **Modularity:** Scene isolation, independent layer rendering.
*   **Performance-aware:** Instancing, LOD, async loading for 3D assets.
*   **Emotionally Driven:** Lighting, motion, and visuals aligned with narrative stages and keywords (joy, hope, awe, calm, etc.).
*   **Glassmorphism:** For 2D modals, creating a sense of depth and light.
*   **Unified Color Palette:** Sapphire Blue, Rose Gold, Insight Gold, Growth Teal, Reflection Amethyst, Connection Coral, Alabaster White, Charcoal Grey.
*   **Typography:** Montserrat (headings/UI), Lora (body/content).

## 2. Knowledge Model

The Knowledge Model defines how user memories and insights are structured. It supports the backend logic and directly informs the visualization in the `Cosmos Graph Scene` and the content of `Cards` in the 2D Modal Layer.

### 2.1 Core Knowledge Graph Schema

(Node and Relationship Types largely as in V4, with additions/clarifications for UI integration)

#### Node Types

1.  **`User`**: As in V4.
    *   Properties: `userId`, `name`, `preferences` (includes UI settings, Orb interaction style), `growth_dimensions_summary` (JSONB for Six-Dimensional Growth).
2.  **`MemoryUnit`**: As in V4.
    *   Properties: `muid`, `creation_ts`, `last_modified_ts`, `source_type`, `title`, `processing_status`, `importance_score`.
    *   **UI Link:** Can be represented as a `Card` or a node in `Cosmos Graph`.
3.  **`Chunk`**: As in V4.
4.  **`Concept`**: As in V4.
    *   Properties: `concept_id`, `name`, `type`, `description`, `user_defined`, `confidence`, `last_updated_ts`, `community_id`.
    *   **UI Link:** Primary nodes in `Cosmos Graph`, represented as `Cards`. `Concept.type` influences visual appearance (color, shape, icon) in UI.
    *   The `type` property draws from a controlled vocabulary:
        *   Self Domain: "value", "personal_trait", "skill", "emotion", "interest", "struggle"
        *   Life Events Domain: "life_event_theme", "achievement", "decision_point", "milestone"
        *   Relationships Domain: "person", "organization", "group", "relationship_dynamic"
        *   Future Orientation Domain: "goal", "aspiration", "plan", "concern"
        *   General: "location", "time_period", "activity", "artwork", "topic", "abstract_idea"
5.  **`Media`**: As in V4.
6.  **`Annotation`**: As in V4.
    *   `annotation_type` can include tags related to the "Six-Dimensional Growth Model" (e.g., `know_self_reflection`, `act_world_plan`).
7.  **`Community`**: As in V4.
    *   **UI Link:** Visualized as clusters or constellations in `Cosmos Graph`.
8.  **`DerivedArtifact` (NEW for UI/UX consistency):**
    *   Properties: `daid` (unique), `user_id`, `title`, `summary_text`, `artifact_type` (e.g., "story_thread", "themed_collection", "insight_summary"), `source_element_ids` (JSON array of muid/cid/concept_id), `creation_ts`, `last_modified_ts`.
    *   Purpose: Represents user- or AI-curated collections or narratives built from existing graph elements, often presented as a special `Card`. Created by `Insight Engine` or `Dialogue Agent`. Stored in PostgreSQL.
    *   **UI Link:** Represented as a distinct `Card` type in the gallery, possibly with unique visual treatment.

#### Relationship Types

(As in V4, with emphasis on visual representation)

1.  `(User)-[:AUTHORED]->(MemoryUnit)`
2.  `(MemoryUnit)-[:CONTAINS]->(Chunk)`
3.  `(MemoryUnit)-[:HIGHLIGHTS]->(Concept)`
4.  `(Chunk)-[:MENTIONS]->(Concept)`
5.  `(MemoryUnit)-[:INCLUDES]->(Media)`
6.  `(Concept)-[:RELATED_TO]->(Concept)`
    *   **UI Link:** The primary connections visualized as glowing trails or lines in `Cosmos Graph`. `relationship_label` can influence trail appearance (color, animation).
7.  `(User)-[:PERCEIVES]->(Concept)`
8.  `(MemoryUnit)-[:CONTINUES]->(MemoryUnit)`
9.  `(Annotation)-[:ANNOTATES]->(MemoryUnit | Chunk | Concept)`
10. `(Concept)-[:BELONGS_TO]->(Community)`
11. `(DerivedArtifact)-[:BASED_ON]->(MemoryUnit | Concept)` (NEW)

### 2.1.A Six-Dimensional Growth Model (NEW Integration)

This UI concept needs backend support for tracking and display on `Cards`.
| Dimension        | Categories                                     | Backend Tracking                                                                                                |
| :--------------- | :--------------------------------------------- | :-------------------------------------------------------------------------------------------------------------- |
| **Self Side**    | Know Self, Act for Self, Show Self             | Stored in a new PostgreSQL table `user_concept_growth` (`user_id`, `concept_id`, `dimension`, `status`, `evidence_link`) |
| **World Side**   | Know World, Act for World, Show to World         | or as JSONB array on `Concept` or `User` specific relations.                                                     |

*   **Activation Logic:**
    *   `Unactivated`: Default state for new `Concept` cards.
    *   `In Progress`: User initiates interaction (e.g., journaling prompt on card).
    *   `Activated` (per dimension): `Ingestion Analyst` or `Dialogue Agent` identifies relevant user input (e.g., an `Annotation` with type `know_self_reflection` on a `Concept` updates the "Know Self" dimension for that concept's card).
    *   `Fully Linked`: Based on graph connectivity (`RELATED_TO` count) or `Community` membership.
*   The `Dialogue Agent` and `Ingestion Analyst` will be responsible for interpreting user inputs to update these dimensions.
*   The `Retrieval Planner` will fetch this status for card display.

### 2.2 The Four Domains of Understanding

(As in V4, these are emergent perspectives queried from the graph, visualized through filtering/highlighting in `Cosmos Graph` or curated `Card` collections).

### 2.3 Schema Governance and Evolution

(As in V4, managed by Ontology Steward).

### 2.4 Vector Embedding Strategy

(As in V4).

## 3. Cognitive Agents: Implementation & Responsibilities

### 3.1 Dialogue Agent (Dot)

**Purpose:** The sole user-facing agent, visually represented as the **3D Orb**. Responsible for understanding user needs, formulating responses, dictating Orb appearance/behavior, managing UI state transitions (e.g., suggesting scene changes), and delegating to other agents.

#### Implementation Details:

**Input Payload (from UI):**
```json
{
  "user_id": "string",
  "message_text": "string", // or speech-to-text
  "message_media": [{"type": "string", "url": "string"}],
  "conversation_id": "string",
  "message_id": "string",
  "timestamp": "ISO8601",
  "current_ui_scene": "string", // "Flight", "Ascension", "CosmosGraph", "ModalFocus_CardGallery"
  "active_modal_context": { // Optional, if a modal is active
    "modal_type": "string", // "CardView", "Dashboard"
    "entity_id": "string" // e.g., concept_id of the card being viewed
  }
}
```

**Output Payload (to UI):**
```json
{
  "response_text": "string",
  "response_media": [{"type": "string", "url": "string"}],
  "suggested_actions": [ // For UI buttons, card interactions
    {"action_type": "string", "label": "string", "payload": "object"} 
    // e.g., {"action_type": "OPEN_CARD", "payload": {"concept_id": "xyz"}}
    // e.g., {"action_type": "NAVIGATE_SCENE", "payload": {"scene_name": "CosmosGraph"}}
  ],
  "proactive_insight": {"text": "string", "source": "string", "confidence": "float", "related_card_id": "string"},
  "orb_state": { // NEW: For controlling 3D Orb appearance and behavior
    "visual_state": "string", // "idle", "listening", "thinking", "speaking", "excited", "calm_guidance", "transforming"
    "target_color_palette": "string", // "AmethystFocus", "JourneyGoldInsight", "Neutral"
    "animation_cue": "string", // "pulse_soft", "sparkle_burst", "leading_stream"
    "position_hint": "string" // "bottom_center_scene", "near_active_card", "lead_camera" 
  },
  "modal_updates": { // NEW: For controlling 2D Modal Layer
    "show_modal": "string", // "CardView", "Dashboard", "ChatDialogue"
    "modal_content_id": "string", // e.g., concept_id, insight_id
    "highlight_cards": ["string"] // List of card IDs to highlight in gallery
  },
  "metadata": {"processing_time": "float", "tool_calls": []}
}
```

**Cognitive Process:**
1.  Classify input intent and consider `current_ui_scene` and `active_modal_context`.
2.  Determine appropriate Orb visual response (`orb_state`).
3.  Delegate to `Retrieval Planner` or `Insight Engine` as needed.
4.  Formulate `response_text` and `suggested_actions`.
5.  If new content is generated for a card (e.g., reflection on a Concept), pass to `Ingestion Analyst`.
6.  Determine if UI state changes are needed (e.g., `modal_updates`, suggesting scene navigation).
7.  **Orb Behavior Logic:** Based on context (e.g., `CloudScene` -> calm Orb; `CosmosGraph` query -> thinking then insightful Orb). The UI/UX notes for Orb behavior per scene are key inputs here.

**Tool Use:** As in V4.
**LLM Configuration:** As in V4.
**State Handling:** As in V4.

### 3.2 Ingestion Analyst

**Purpose:** Processes raw user inputs (from chat with Orb, journal entries via Cards, document uploads) into structured entities and relationships. Updates "Six-Dimensional Growth Model" status.

#### Implementation Details:

**Input Payload:** (As in V4, can also include `target_entity_id` if input is related to a specific Card/Concept).
**Output Payload:** (As in V4, plus potential updates to `user_concept_growth` table).

**Cognitive Process:**
1.  Capture Decision, Tiered Processing Strategy, Content Chunking, Entity & Relationship Extraction (as in V4).
2.  **Growth Dimension Update:** If input relates to a `Concept` card and contains reflective content, use LLM or rule-based logic to determine if it contributes to one of the six growth dimensions. Update `user_concept_growth` in PostgreSQL. This will change the visual state of the `Card` in the UI.

**Tool Use:** As in V4.
**LLM Configuration:** As in V4.
**Optimization Strategy:** As in V4.

### 3.3 Retrieval Planner

**Purpose:** Orchestrate hybrid retrieval for user queries (via Orb), populating `Card` details, fetching data for `Cosmos Graph` visualization, and supplying content for the `Dashboard`.

#### Implementation Details:

**Input Payload:** (As in V4, can also include `ui_context: "CosmosGraphNodeExpansion"` or `ui_context: "CardDetailView"`).
**Output Payload:** (As in V4, `context_bundle` now also includes `growth_dimension_status` for relevant concepts/cards).

**Cognitive Process:**
1.  Query Analysis, Retrieval Planning, Execution & Reranking (as in V4).
2.  **UI-Specific Formatting:** Tailor output for `Cosmos Graph` (node/edge lists with visual properties) or `Card` display (content, related items, growth status).

**Tool Use:** As in V4.
**LLM Configuration:** As in V4.
**Optimization Strategy:** As in V4.

### 3.4 Insight Engine

**Purpose:** Discover patterns, connections, hypotheses. Can generate `DerivedArtifacts` for `Card` display or suggest new connections in `Cosmos Graph`.

#### Implementation Details:

**Output Payload:** (As in V4, `insights` can now include suggestions for `DerivedArtifact` creation, which will appear as new `Cards`).
**Cognitive Process:** As in V4, with an added step:
5.  **Artifact Generation:** If significant patterns or narratives are found, propose or create `DerivedArtifact` nodes/records, linking them to their source elements. These can then be surfaced as special `Cards` by the `Dialogue Agent`.

**Tool Use:** As in V4.
**LLM Configuration:** As in V4.
**Optimization Strategy:** As in V4.

### 3.5 Ontology Steward

(As in V4. No direct UI changes, but its management of `Concept.type` and `relationship_label` indirectly affects `Cosmos Graph` visuals).

## 4. Deterministic Tools Layer

(As in V4. These tools are used by agents to process data that ultimately populates UI elements or responds to UI interactions).

## 5. Persistence Layer Implementation

(Primarily as in V4, with additions for UI-specific data).

### 5.1 PostgreSQL (Relational Database)

**Key Tables & Schema (Additions/Modifications):**

**Users Table:** (As in V4)
```sql
-- Add to preferences JSONB:
-- "ui_theme": "string" (e.g., "sunset_flight", "cosmic_dawn")
-- "orb_interaction_style": "string" ("proactive", "responsive")
-- "default_scene": "string" ("Flight", "CosmosGraph")
```

**Concepts Table:** (As in V4)
```sql
-- Add (optional, if not in a separate table):
-- growth_dimensions_status JSONB -- Tracks { "know_self": "activated", "act_world": "in_progress" ... }
```

**NEW Table: UserConceptGrowth**
```sql
CREATE TABLE user_concept_growth (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(36) REFERENCES users(user_id) ON DELETE CASCADE,
    target_entity_id VARCHAR(36) NOT NULL, -- Can be concept_id, muid
    target_entity_type VARCHAR(20) NOT NULL, -- "Concept", "MemoryUnit"
    dimension_key VARCHAR(50) NOT NULL, -- e.g., "know_self", "act_world"
    status VARCHAR(20) NOT NULL DEFAULT 'unactivated', -- "unactivated", "in_progress", "activated"
    last_updated_ts TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    evidence_annotation_id VARCHAR(36) -- Optional link to an Annotation
    -- UNIQUE (user_id, target_entity_id, dimension_key)
);
CREATE INDEX idx_user_concept_growth_user_entity ON user_concept_growth(user_id, target_entity_id);
```

**NEW Table: DerivedArtifacts**
```sql
CREATE TABLE derived_artifacts (
    daid VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) REFERENCES users(user_id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    summary_text TEXT,
    artifact_type VARCHAR(50) NOT NULL, -- "story_thread", "themed_collection"
    source_element_ids JSONB, -- Array of {"id": "xxx", "type": "Concept"}
    ui_properties JSONB, -- e.g., {"card_icon": "path/to/icon.png", "card_color": "#hex"}
    creation_ts TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_modified_ts TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_derived_artifacts_user ON derived_artifacts(user_id, creation_ts);
```

(Other tables like MemoryUnits, Chunks, Annotations, Media, ConversationLog, InsightsTable as in V4).

### 5.2 Neo4j (Graph Database)

(Node Labels and Relationship Types as defined in Section 2, including new `DerivedArtifact` node and its relationships, if chosen to be modeled in graph too, or linked via properties).
The `Cosmos Graph Scene` will primarily query Neo4j for `Concept` nodes, `Community` nodes, and their `RELATED_TO` relationships. Properties on these nodes/relationships will drive visual attributes (size, color, glow, line style) as specified in the Cosmos Scene UI notes.

### 5.3 Weaviate (Vector Database)

(As in V4. Used for semantic search to find relevant `Cards` or `Cosmos Graph` nodes).

### 5.4 Redis (Cache & Queues)

(As in V4. Caching graph query results for `Cosmos Graph` or `Card` data will be important for UI responsiveness).

## 6. Data Flow & Processing

(Flows as in V4, but with UI interactions as triggers and UI updates as results).

### 6.1 Ingestion Flow (Example with Card Interaction)

1.  **User Interaction:** User clicks a `Card` representing a `Concept` (e.g., "My Value of Courage") in the `Infinite Card Gallery` (2D Modal Layer). A modal opens with a prompt: "Reflect on a time courage guided you." User types or speaks a journal entry.
2.  **Input to Dialogue Agent:** UI sends input to `Dialogue Agent (Orb)` with `active_modal_context` identifying the "Courage" `Concept` card.
3.  **Dialogue Agent Processing:**
    *   Determines Orb state (e.g., `listening`, then `thinking`).
    *   Passes the journal entry and `concept_id` for "Courage" to `Ingestion Analyst`.
4.  **Ingestion Analyst Processing:**
    *   Creates `MemoryUnit`, `Chunks`.
    *   Extracts entities, links new `MemoryUnit` to "Courage" `Concept` via `HIGHLIGHTS`.
    *   Analyzes if the reflection updates a "Six-Dimensional Growth Model" aspect for "Courage" (e.g., "Show Self"). Updates `user_concept_growth` table.
    *   Queues embedding jobs.
5.  **UI Update:** `Dialogue Agent` sends a response to UI:
    *   `response_text`: "Thank you for sharing that moment."
    *   `orb_state`: `calm_guidance`.
    *   `modal_updates`: Suggests closing the journal modal or highlighting the updated "Courage" card which now shows visual progress in its growth dimension.
    *   The `Card` for "Courage" in the gallery visually updates its state based on the new data in `user_concept_growth`.

### 6.2 Retrieval Flow (Example with Cosmos Graph)

1.  **User Interaction:** User is in `Cosmos Graph Scene` and clicks on a `Concept` node (e.g., "Creativity").
2.  **Input to Dialogue Agent:** UI sends request for details on "Creativity" node.
3.  **Dialogue Agent Processing:**
    *   Sets `orb_state` to `thinking`.
    *   Delegates to `Retrieval Planner` with query for "Creativity" `concept_id` and context `CosmosGraphNodeExpansion`.
4.  **Retrieval Planner Execution:**
    *   Fetches `Concept` details, related `MemoryUnits` (titles, dates), connected `Concepts`, and `growth_dimension_status` from PostgreSQL and Neo4j.
    *   Assembles `context_bundle`.
5.  **Response Generation & UI Update:**
    *   `Dialogue Agent` receives bundle.
    *   Sends output to UI:
        *   `orb_state`: `speaking_insight`.
        *   `modal_updates`: Instructs UI to open a `Card-Specific Modal` for "Creativity", populated with fetched details.
        *   The `Cosmos Graph Scene` might highlight connected nodes or animate the selected "Creativity" node.

## 7. Technical Implementation

(As in V4, with UI specific additions).

### 7.1 Monorepo Structure

```
/2dots1line-monorepo/
├── apps/
│   ├── web-app/                      # Next.js (React) Frontend
│   │   ├── components/
│   │   │   ├── canvas/               # 3D Canvas scenes (Flight, Ascension, CosmosGraph)
│   │   │   │   └── scenes/
│   │   │   │       ├── FlightScene.tsx
│   │   │   │       ├── AscensionScene.tsx
│   │   │   │       └── CosmosGraphScene.tsx
│   │   │   ├── modals/               # 2D Modals (Card Gallery, Dashboard, Chat)
│   │   │   ├── orb/                  # 3D Orb component
│   │   │   └── hud/                  # HUD component
│   │   ├── threejs-helpers/          # Utilities for R3F
│   │   └── store/                    # Zustand/Redux for UI state
│   ├── mobile-app/                   # React Native App (with simplified 3D or 2.5D views)
│   └── backend-api/                  # (As in V4)
├── packages/                         # (As in V4)
│   ├── shared-types/                 # Includes OrbState, ModalUpdate types
├── services/                         # (As in V4)
├── workers/                          # (As in V4)
├── infrastructure/                   # (As in V4)
├── docs/                             # (As in V4)
└── scripts/                          # (As in V4)
```

### 7.2 API Design

(As in V4, with emphasis on payloads supporting UI state).

**Core REST API Endpoints / GraphQL mutations & queries must support:**
*   Fetching data for `Cards` including their `growth_dimension_status`.
*   Fetching `Concept`, `Community`, and `Relationship` data tailored for `Cosmos Graph` visualization (including properties that map to visual styles).
*   Endpoints for `Dialogue Agent` that accept `current_ui_scene` and `active_modal_context` and return `orb_state` and `modal_updates`.
*   Endpoints for updating `user_concept_growth` status.

**Real-time Communication:**
*   Consider **WebSockets** for pushing `orb_state` changes or proactive `modal_updates` from the `Dialogue Agent` to the UI for a more fluid and responsive Orb and notification system.

### 7.3 Security Considerations

(As in V4).

### 7.4 Testing Strategy

(As in V4, with additions):
*   **UI Integration Tests:** Testing interaction between UI layers (Orb triggering modals, Cosmos nodes opening cards).
*   **Visual Regression Tests:** For 3D scenes and complex UI components.
*   **End-to-End Scenario Tests:** E.g., User journals via a Card -> data ingested -> Cosmos Graph node updates -> Insight generated -> Orb proactively shares insight via a new Card.

## 8. UI/UX Detailed Implementation Notes

This section directly incorporates the detailed UI/UX specifications provided.

### 8.1 Unified Design System & 3D Canvas Implementation

*   **Core Stack:** `three.js`, `@react-three/fiber`, `@react-three/drei`, `zustand` (for scene/UI state management), `tailwindcss`.
*   **Global Canvas Layout (`CanvasLayout.tsx`):**
    ```jsx
    <div className="relative w-screen h-screen bg-black"> {/* Ensure background for 3D canvas */}
      <Canvas camera={{ fov: 60, position: [0,0,8] /* initial for Cosmos */ }} shadows>
        <SceneManager currentScene={uiStore.currentScene} />
        <Lights /> {/* Configurable per scene */}
        <SharedAssets /> {/* Skybox, fog shaders if global */}
        <OrbComponent orbState={dialogueAgentStore.orbStateFromAPI} /> {/* Orb rendered via R3F */}
      </Canvas>
      <HUD /> {/* HTML overlay */}
      <ModalLayer modals={uiStore.activeModals} /> {/* HTML overlay with glassmorphism */}
    </div>
    ```
*   **Scene Manager (`SceneManager.tsx`):** Switches between `<FlightScene />`, `<AscensionScene />`, `<CosmosGraphScene />` based on `uiStore.currentScene`. Each scene is a React component using R3F.
*   **Camera & Controls:** PerspectiveCamera, with movement modes (orbit for Cosmos, auto-pathing for Flight/Ascension) managed by `drei` (e.g., `OrbitControls`, custom pathing hooks). Transitions use `lerp` and easing functions.
*   **Visual Effects:**
    *   Clouds: Alpha-blended planes, volumetric shaders (e.g., `three-volumetric-clouds`).
    *   Fog: `FogExp2` or custom shaders.
    *   Starfield: `PointsMaterial`, `ShaderMaterial` for GPU particles, `drei/Stars`.
    *   Bloom: `UnrealBloomPass` from `@react-three/postprocessing`.
    *   Color Grading: `ACESFilmicToneMapping`.
*   **DOM Overlay Integration:** HUD and Modals are HTML elements styled with TailwindCSS, positioned absolutely over the `<Canvas>`. `pointer-events` managed carefully.

### 8.1.1 Flight Scene (`FlightScene.tsx`)

*   **Camera:** Slow diagonal drift (bottom-left to upper-right), `easeInOutSine` easing. No fixed focus.
*   **Composition:** 60% sky, 30% cloudscape, 10% snowy peaks (parallaxed heightmap or distant meshes).
*   **Clouds:** Layered stratus/cumulus (alpha-blended cards or volumetric shaders). Gentle west-to-east drift.
    *   Backend Link: Orb prompts ("Breathe in...") come from `Dialogue Agent` with `orb_state.visual_state: "calm_guidance"`.
*   **Lighting:** Directional light (upper-right), low-angle sun. Palette: violet -> coral -> amber -> white.
*   **Looping:** Seamless tile animation for clouds/landscape.

### 8.1.2 Ascension Scene (`AscensionScene.tsx`)

*   **Camera:** Vertical diagonal path, `easeInOutExpo` -> `easeOutCirc`. Slow drift -> accel -> sudden stillness. FOV narrows then expands.
*   **Cloud/Light Transition:**
    1.  Atmospheric Accel: Layered clouds rush past.
    2.  Tunneling: Clouds thin, stretch (speed lines).
    3.  Boundary Break: Cloud veil tears, flash bloom white -> dark silence. Radical motion slow.
*   **Arrival:** Faint starscape expands. Light fog. Wind silences.
    *   Backend Link: Orb becomes stream of light. Dialogue ("You've entered your own space") from `Dialogue Agent`. `orb_state.visual_state: "transforming_lead"`.
*   **Timeline:** ~8-12 seconds.

### 8.1.3 Cosmic Knowledge Graph Scene (`CosmosGraphScene.tsx`)

*   **Environment:** Deep cosmos backdrop (black/indigo gradient, star fog). Ambient + radiant node glows. Parallax stars.
*   **Node Representation (from Neo4j `Concept` data):**
    *   `Node Dot`: `SphereGeometry` with `MeshStandardMaterial` (emissive, metalness, roughness). Radius 0.35 units.
    *   `Glow Aura`: Additive blending, `MeshBasicMaterial`.
    *   `Node Types`: `Concept.type` maps to color (Growth Aurora, Reflection Amethyst), potentially subtle shape/halo differences via shader uniforms or varied geometry.
    *   `Selected Node`: Scaled up (1.2x), emits particles. Triggers API call to `Dialogue Agent` for card modal.
    *   `Inactive Nodes`: Dimmed (opacity 0.5).
*   **Interaction:** Raycasting for hover/click. `easeOutCubic` for hover animation.
*   **Edges/Connection Trails (from Neo4j `RELATED_TO` data):**
    *   `Line2` with `LineMaterial` (dashed). Width 0.01 units.
    *   Color based on `relationship_label`.
*   **Camera:** `OrbitControls` (dampened), `lerp` for focus transitions.
*   **Effects:** `FogExp2`, `Points` for starfield, bloom.
    *   Backend Link: Data fetched via `Retrieval Planner`. Orb behavior (`cosmic_companion`) from `Dialogue Agent`.

### 8.2 2D Modal Layer & Card System

*   **Infinite Card Gallery:**
    *   Rendered as a scrollable HTML grid (e.g., using CSS Grid or a virtualized list for performance).
    *   Each card is an HTML element with glassmorphism (`backdrop-filter: blur(20px)`, semi-transparent background).
    *   **Card Data:** Content (`MemoryUnit.title`, `Concept.name`, `DerivedArtifact.title`), image/icon, type comes from PostgreSQL.
    *   **Six-Dimensional Growth Model & Visual States:**
        *   `Unactivated`: Greyscale, blurred icon.
        *   `In Progress`: Pulsing ring/segments (CSS animation).
        *   `Activated`: Full color, motion halo (CSS/SVG animation). State driven by `user_concept_growth` data.
        *   `Fully Linked`: Visual cues based on `Concept` connectivity.
    *   Clicking card opens `Card-Specific Modal` by updating UI state, triggering data fetch via `Dialogue Agent` -> `Retrieval Planner`.
*   **Card-Specific Modal:**
    *   HTML modal. Header (title, icon, growth chips), Body (text/media from `MemoryUnit`/`Chunk`/`Annotation`, or input for `Ingestion Analyst`), Progress Indicator (SVG/CSS visualization of 6D growth), Linked Concepts (smaller cards).
*   **Dashboard:** HTML modal populated with data fetched by `Dialogue Agent` (insights, stats, etc.).
*   **Chat Modal:** HTML component, can be fixed or draggable. Interfaces with `Dialogue Agent` API.
*   **HUD:** Fixed position HTML element with buttons triggering UI state changes (scene navigation, modal toggles).

### 8.3 3D Orb Implementation (`OrbComponent.tsx`)

*   **Shape & Material:** High-poly `SphereGeometry`. Multi-layered material:
    1.  **Core:** Emissive center, radial falloff shader (animated gradient: Aurora Teal -> Amethyst -> Journey Gold).
    2.  **Outer Shell:** Transparent, glossy, Fresnel edge glow, slight iridescence (shader).
    3.  **Aura/Halo:** Bloom effect or instanced particles.
*   **Color Behavior:** Dynamically set by `orb_state.target_color_palette` from `Dialogue Agent` API response.
*   **Motion:**
    *   Idle: Gentle float (sine wave on Y), slow rotation.
    *   Hovered/Focused (if Orb is directly interactable): Scales up, glow pulse.
    *   Engaged (speaking, listening): Color transitions, core pulses, spark trails. Driven by `orb_state.visual_state` and `orb_state.animation_cue`.
*   **Positioning:** Its transform (position, rotation) in the 3D scene is updated based on `orb_state.position_hint` and current scene logic (e.g., follow camera, orbit node, stay in corner).
*   **Technical:** `three.js` shader materials for advanced effects. `UnrealBloomPass` for glow.

### 8.4 Mobile-Specific Considerations

(As in V4, with a note that 3D scenes might be simplified or use baked lighting/2.5D parallax effects for performance. Orb might be a 2D animated sprite with similar visual cues if full 3D is too heavy).

## 9. Deployment Strategy

(As in V4. CDN for 3D assets and frontend bundles will be critical).

## 10. Conclusion & Next Steps

### 10.1 Implementation Roadmap

**Phase 1: Foundation (Months 1-3)**
- Core knowledge model (PostgreSQL, Neo4j, Weaviate).
- Basic Ingestion Analyst & `Dialogue Agent (Orb)` (text chat, basic Orb states).
- Minimal viable UI: Static `FlightScene`, basic 2D `Card Gallery` (read-only), `Chat Modal`.
- Setup R3F canvas, basic Orb rendering.

**Phase 2: Core Capabilities (Months 4-6)**
- Enhanced `Retrieval Planner`, `Dialogue Agent` handles `orb_state` and `modal_updates`.
- Interactive `Card Gallery` with `Card-Specific Modals` for journaling (triggers `Ingestion Analyst`).
- `Cosmos Graph Scene` MVP (displaying `Concept` nodes and relationships).
- Implement `Six-Dimensional Growth Model` backend logic and card visuals.
- Dynamic Orb appearance based on `Dialogue Agent` state.

**Phase 3: Immersion & Intelligence (Months 7-9)**
- Full `FlightScene` and `AscensionScene` with Orb behaviors.
- `Insight Engine` MVP, insights surfaced in `Dashboard` and via Orb/Cards.
- `Ontology Steward`. Advanced `Cosmos Graph` interactions (node expansion, filtering).
- Polish Orb animations and transitions.

**Phase 4: Advanced Features & Polish (Months 10-12)**
- Full 3D Lifeweb/Cosmos Graph interactivity as per UI spec.
- `DerivedArtifacts` creation and display.
- Performance optimization for 3D and data fetching.
- Cross-region deployment. Mobile app MVP.

### 10.2 Critical Success Factors

(As in V4, adding):
5.  **UI/UX Excellence:** Achieving the desired emotional resonance and fluid interaction between the 3D and 2D layers. Performance of the 3D canvas is paramount.
6.  **Seamless Backend-Frontend Integration:** Ensuring the Orb's behavior and UI state changes feel genuinely driven by the AI's "thoughts" and data.

### 10.3 Open Questions & Research Areas

(As in V4, adding):
5.  **3D Performance Optimization:** Techniques for rendering complex, dynamic 3D scenes smoothly on web and mobile.
6.  **Orb Believability:** Fine-tuning Orb animations, responses, and proactive behaviors to feel like a natural, empathetic companion.
7.  **Intuitive Navigation:** Balancing the immersive 3D environment with clear, accessible controls for information access and interaction in the 2D layer.

This V5 specification provides a comprehensive blueprint for 2dots1line, integrating a sophisticated backend with a groundbreaking, emotionally rich user experience. The synergy between the AI's cognitive capabilities and its visual embodiment in the Orb, set within immersive 3D worlds and structured 2D interfaces, aims to deliver a truly unique and transformative personal knowledge system.